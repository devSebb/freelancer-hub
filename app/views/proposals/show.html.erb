<div data-controller="pdf-preview"
     data-pdf-preview-preview-url-value="<%= preview_pdf_proposal_path(@proposal) %>"
     data-pdf-preview-download-url-value="<%= export_pdf_proposal_path(@proposal) %>">
  <!-- Back Link -->
  <div class="mb-6">
    <%= link_to proposals_path, class: "inline-flex items-center text-sm text-white/50 hover:text-white transition-colors" do %>
      <%= icon(:back, size: :sm, css_class: "mr-2") %>
      <%= t("common.back") %>
    <% end %>
  </div>

  <!-- Header -->
  <div class="flex items-start justify-between mb-8">
    <div>
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-white tracking-tight"><%= @proposal.title %></h1>
        <%= render "proposals/status_badge", proposal: @proposal %>
      </div>
      <% if @proposal.client %>
        <p class="text-white/50">
          <%= t("proposals.client") %>:
          <%= link_to @proposal.client.name, @proposal.client, class: "text-accent hover:text-accent-light transition-colors" %>
        </p>
      <% end %>
    </div>

    <div class="flex items-center gap-3">
      <% if @proposal.draft? %>
        <%= link_to edit_proposal_path(@proposal), class: "inline-flex items-center gap-2 px-4 py-2.5 bg-white/10 text-white text-sm font-medium rounded-full hover:bg-white/20 transition-all duration-200" do %>
          <%= icon(:edit, size: :sm) %>
          <%= t("common.edit") %>
        <% end %>

        <% if @proposal.client.present? %>
          <%= button_to send_proposal_proposal_path(@proposal), method: :post, class: "inline-flex items-center gap-2 px-5 py-2.5 bg-white text-black text-sm font-semibold rounded-full hover:bg-white/90 transition-all duration-200" do %>
            <%= icon(:send, size: :sm) %>
            <%= t("proposals.send_proposal") %>
          <% end %>
        <% end %>
      <% else %>
        <%= link_to public_proposal_url(@proposal.share_token), target: "_blank", class: "inline-flex items-center gap-2 px-4 py-2.5 bg-white/10 text-white text-sm font-medium rounded-full hover:bg-white/20 transition-all duration-200" do %>
          <%= icon(:external_link, size: :sm) %>
          <%= t("proposals.view_public") %>
        <% end %>
      <% end %>

      <!-- Export PDF (opens preview panel) -->
      <button type="button" data-action="click->pdf-preview#open"
              class="inline-flex items-center gap-2 px-4 py-2.5 bg-white/10 text-white text-sm font-medium rounded-full hover:bg-white/20 transition-all duration-200">
        <%= icon(:export_pdf, size: :sm) %>
        <%= t("common.export_pdf") %>
      </button>

      <!-- Save as Template dropdown -->
      <div class="relative" data-controller="dropdown">
        <button type="button" data-action="click->dropdown#toggle" class="inline-flex items-center gap-2 px-4 py-2.5 bg-white/10 text-white text-sm font-medium rounded-full hover:bg-white/20 transition-all duration-200">
          <%= icon(:template, size: :sm) %>
          <%= t("proposal_templates.save_as_template") %>
        </button>
        <div data-dropdown-target="menu" class="hidden absolute right-0 mt-2 w-72 bg-zinc-900 border border-white/10 rounded-xl shadow-xl z-10 overflow-hidden">
          <div class="p-4">
            <%= form_with url: save_as_template_proposal_path(@proposal), method: :post, class: "space-y-4" do |f| %>
              <div>
                <%= f.label :template_name, t("proposal_templates.name"), class: "block text-sm font-medium text-white/70 mb-2" %>
                <%= f.text_field :template_name, value: "#{@proposal.title} Template", class: "w-full px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-white text-sm placeholder-white/30 focus:outline-none focus:border-white/30" %>
              </div>
              <%= f.submit t("common.save"), class: "w-full py-2 bg-white text-black text-sm font-semibold rounded-full hover:bg-white/90 transition-all cursor-pointer" %>
            <% end %>
          </div>
        </div>
      </div>

      <%= button_to proposal_path(@proposal), method: :delete,
          data: { turbo_confirm: t("proposals.confirm_delete") },
          class: "inline-flex items-center justify-center p-2.5 bg-red-400/20 text-red-400 text-sm font-medium rounded-full hover:bg-red-400/30 transition-all duration-200",
          aria: { label: t("common.delete") } do %>
        <%= icon(:delete, size: :sm, css_class: "text-red-400") %>
      <% end %>
    </div>
  </div>

  <!-- Status Timeline -->
  <% unless @proposal.draft? %>
    <div class="bg-white/5 border border-white/10 rounded-2xl p-5 mb-6">
      <div class="flex items-center gap-8 text-sm">
        <div class="flex items-center text-accent">
          <%= icon(:check_circle, variant: :duotone, size: :sm, css_class: "mr-2 text-accent") %>
          <span>Sent <%= @proposal.sent_at&.strftime("%b %d, %Y %I:%M %p") %></span>
        </div>
        <% if @proposal.viewed_at || @proposal.viewed? || @proposal.accepted? %>
          <div class="flex items-center text-accent">
            <%= icon(:check_circle, variant: :duotone, size: :sm, css_class: "mr-2 text-accent") %>
            <span>Viewed <%= @proposal.viewed_at&.strftime("%b %d, %Y %I:%M %p") %></span>
          </div>
        <% else %>
          <div class="flex items-center text-white/40">
            <%= icon(:circle_outline, size: :sm, css_class: "mr-2 text-white/30") %>
            <span>Not viewed yet</span>
          </div>
        <% end %>
        <% if @proposal.accepted? %>
          <div class="flex items-center text-accent">
            <%= icon(:check_circle, variant: :duotone, size: :sm, css_class: "mr-2 text-accent") %>
            <span>Accepted <%= @proposal.signature_at&.strftime("%b %d, %Y %I:%M %p") %></span>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <!-- Proposal Content -->
  <div class="space-y-6">
    <!-- Scope -->
    <% if @proposal.scope.present? %>
      <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4"><%= t("proposals.scope") %></h2>
        <div class="text-white/70 prose prose-sm prose-invert max-w-none">
          <%= simple_format(@proposal.scope) %>
        </div>
      </div>
    <% end %>

    <!-- Deliverables -->
    <% if @proposal.deliverables.present? %>
      <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4"><%= t("proposals.deliverables") %></h2>
        <div class="text-white/70 prose prose-sm prose-invert max-w-none">
          <%= simple_format(@proposal.deliverables) %>
        </div>
      </div>
    <% end %>

    <!-- Timeline & Pricing -->
    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
      <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4"><%= t("proposals.timeline") %></h2>
        <dl class="space-y-3">
          <div class="flex justify-between">
            <dt class="text-sm text-white/50"><%= t("proposals.timeline_start") %></dt>
            <dd class="text-sm text-white"><%= @proposal.timeline_start&.strftime("%b %d, %Y") || "—" %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-white/50"><%= t("proposals.timeline_end") %></dt>
            <dd class="text-sm text-white"><%= @proposal.timeline_end&.strftime("%b %d, %Y") || "—" %></dd>
          </div>
          <% if @proposal.expires_at.present? %>
            <div class="flex justify-between">
              <dt class="text-sm text-white/50"><%= t("proposals.expires_at") %></dt>
              <dd class="text-sm text-white"><%= @proposal.expires_at.strftime("%b %d, %Y") %></dd>
            </div>
          <% end %>
        </dl>
      </div>

      <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4"><%= t("proposals.pricing") %></h2>
        <dl class="space-y-3">
          <div class="flex justify-between">
            <dt class="text-sm text-white/50"><%= t("proposals.pricing_type") %></dt>
            <dd class="text-sm text-white"><%= t("proposals.pricing_types.#{@proposal.pricing_type}") %></dd>
          </div>
          <% if @proposal.fixed? %>
            <div class="flex justify-between">
              <dt class="text-sm text-white/50"><%= t("proposals.amount") %></dt>
              <dd class="text-sm font-semibold text-white"><%= number_to_currency(@proposal.amount) %></dd>
            </div>
          <% else %>
            <div class="flex justify-between">
              <dt class="text-sm text-white/50"><%= t("proposals.hourly_rate") %></dt>
              <dd class="text-sm text-white"><%= number_to_currency(@proposal.hourly_rate) %>/hr</dd>
            </div>
            <div class="flex justify-between">
              <dt class="text-sm text-white/50"><%= t("proposals.estimated_hours") %></dt>
              <dd class="text-sm text-white"><%= @proposal.estimated_hours || "—" %></dd>
            </div>
            <div class="flex justify-between border-t border-white/10 pt-3 mt-3">
              <dt class="text-sm font-medium text-white">Estimated Total</dt>
              <dd class="text-sm font-semibold text-white"><%= number_to_currency(@proposal.total_amount) %></dd>
            </div>
          <% end %>
        </dl>
      </div>
    </div>

    <!-- Terms -->
    <% if @proposal.terms.present? %>
      <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4"><%= t("proposals.terms") %></h2>
        <div class="text-white/70 prose prose-sm prose-invert max-w-none">
          <%= simple_format(@proposal.terms) %>
        </div>
      </div>
    <% end %>

    <!-- Signature (if accepted) -->
    <% if @proposal.accepted? %>
      <div class="bg-accent/10 border border-accent/20 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-accent mb-4">Accepted</h2>
        <dl class="space-y-3">
          <div class="flex justify-between">
            <dt class="text-sm text-accent/70">Signed by</dt>
            <dd class="text-sm font-medium text-white"><%= @proposal.signature_name %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-accent/70">Date</dt>
            <dd class="text-sm text-white"><%= @proposal.signature_at&.strftime("%B %d, %Y at %I:%M %p") %></dd>
          </div>
          <div class="flex justify-between">
            <dt class="text-sm text-accent/70">IP Address</dt>
            <dd class="text-sm text-white"><%= @proposal.signature_ip %></dd>
          </div>
        </dl>
      </div>
    <% end %>
  </div>

  <%= render "shared/pdf_preview_panel",
             preview_url: preview_pdf_proposal_path(@proposal),
             download_url: export_pdf_proposal_path(@proposal),
             resource_title: @proposal.title %>
</div>

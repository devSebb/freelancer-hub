<%= form_with model: invoice, class: "space-y-6", data: { controller: "invoice-items" } do |f| %>
  <% if invoice.errors.any? %>
    <div class="bg-red-400/10 border border-red-400/20 rounded-xl p-4">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <ul class="text-sm text-red-400 space-y-1">
          <% invoice.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <!-- Client & Due Date -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
      <div>
        <%= f.label :client_id, t("invoices.client"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <%= f.collection_select :client_id, current_user.clients.order(:name), :id, :name,
            { prompt: t("invoices.select_client"), include_blank: false },
            { class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-white/30 focus:ring-0 transition-colors" } %>
      </div>

      <div>
        <%= f.label :due_date, t("invoices.due_date"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <%= f.date_field :due_date, class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-white/30 focus:ring-0 transition-colors" %>
      </div>
    </div>
  </div>

  <!-- Line Items -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
    <h2 class="text-lg font-semibold text-white mb-5"><%= t("invoices.line_items") %></h2>

    <!-- Header -->
    <div class="hidden sm:grid grid-cols-12 gap-3 px-4 mb-3">
      <div class="col-span-6 text-xs font-medium text-white/40 uppercase tracking-wider"><%= t("invoices.description") %></div>
      <div class="col-span-2 text-xs font-medium text-white/40 uppercase tracking-wider text-right"><%= t("invoices.qty") %></div>
      <div class="col-span-2 text-xs font-medium text-white/40 uppercase tracking-wider text-right"><%= t("invoices.rate") %></div>
      <div class="col-span-2 text-xs font-medium text-white/40 uppercase tracking-wider text-right"><%= t("invoices.amount") %></div>
    </div>

    <div data-invoice-items-target="container" class="space-y-3">
      <%= f.fields_for :invoice_items do |item_form| %>
        <%= render "invoice_item_fields", f: item_form %>
      <% end %>
    </div>

    <template data-invoice-items-target="template">
      <%= f.fields_for :invoice_items, InvoiceItem.new, child_index: "NEW_RECORD" do |item_form| %>
        <%= render "invoice_item_fields", f: item_form %>
      <% end %>
    </template>

    <button type="button" data-action="invoice-items#add" class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-white/10 text-white text-sm font-medium rounded-full hover:bg-white/20 transition-all duration-200">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
      </svg>
      <%= t("invoices.add_line_item") %>
    </button>
  </div>

  <!-- Discount & Deposit -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
    <h2 class="text-lg font-semibold text-white mb-5"><%= t("invoices.discounts_deposits") %></h2>

    <div class="grid grid-cols-1 gap-5 sm:grid-cols-3">
      <div>
        <%= f.label :discount_type, t("invoices.discount_type"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <%= f.select :discount_type,
            Invoice.discount_types.keys.map { |dt| [t("invoices.discount_types.#{dt}"), dt] },
            {},
            { class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-white/30 focus:ring-0 transition-colors" } %>
      </div>

      <div>
        <%= f.label :discount_value, t("invoices.discount_value"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <%= f.number_field :discount_value, step: 0.01, min: 0, class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-0 transition-colors", placeholder: "0.00" %>
      </div>

      <div>
        <%= f.label :deposit_percent, t("invoices.deposit_percent"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <div class="relative">
          <%= f.number_field :deposit_percent, step: 1, min: 0, max: 100, class: "w-full px-4 py-3 pr-10 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-0 transition-colors", placeholder: "0" %>
          <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
            <span class="text-white/40">%</span>
          </div>
        </div>
        <p class="mt-2 text-xs text-white/40"><%= t("invoices.deposit_hint") %></p>
      </div>
    </div>
  </div>

  <!-- Tax Notes & Notes -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6 space-y-5">
    <div>
      <%= f.label :tax_notes, t("invoices.tax_notes"), class: "block text-sm font-medium text-white/70 mb-2" %>
      <%= f.text_field :tax_notes, class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-0 transition-colors", placeholder: t("invoices.tax_notes_placeholder") %>
      <p class="mt-2 text-xs text-white/40"><%= t("invoices.tax_notes_hint") %></p>
    </div>

    <div>
      <%= f.label :notes, t("invoices.notes"), class: "block text-sm font-medium text-white/70 mb-2" %>
      <%= f.text_area :notes, rows: 3, class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-0 transition-colors resize-none", placeholder: t("invoices.notes_placeholder") %>
    </div>
  </div>

  <!-- Payment Methods -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6"
       data-controller="payment-methods"
       data-payment-methods-methods-value="<%= invoice.payment_methods.to_json %>">
    <div class="flex items-center justify-between mb-5">
      <div>
        <h2 class="text-lg font-semibold text-white"><%= t("invoices.payment_methods.title") %></h2>
        <p class="text-sm text-white/40 mt-1"><%= t("invoices.payment_methods.description") %></p>
      </div>
    </div>

    <!-- Empty State -->
    <div data-payment-methods-target="emptyState" class="<%= 'hidden' if invoice.payment_methods.any? %> text-center py-6">
      <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3">
        <svg class="w-6 h-6 text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z"/>
        </svg>
      </div>
      <p class="text-sm text-white/50"><%= t("invoices.payment_methods.empty_state") %></p>
    </div>

    <!-- Payment Methods List -->
    <div data-payment-methods-target="methodList" class="space-y-4 mb-5"></div>

    <!-- Add Payment Method Buttons -->
    <div class="border-t border-white/10 pt-5">
      <p class="text-xs text-white/40 uppercase tracking-wider mb-3"><%= t("invoices.payment_methods.add_method") %></p>
      <div class="flex flex-wrap gap-2">
        <button type="button" data-action="payment-methods#add" data-type="bank_transfer"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z"/>
          </svg>
          <%= t("invoices.payment_methods.types.bank_transfer") %>
        </button>
        <button type="button" data-action="payment-methods#add" data-type="paypal"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106z"/>
          </svg>
          PayPal
        </button>
        <button type="button" data-action="payment-methods#add" data-type="venmo"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19.5 3c.907 1.416 1.313 2.875 1.313 4.688 0 5.22-4.453 12-8.062 16.312H5.25L2.438 4.5l6.187-.563 1.5 12c1.407-2.25 3.188-5.813 3.188-8.25 0-1.688-.375-2.813-.938-3.75L19.5 3z"/>
          </svg>
          Venmo
        </button>
        <button type="button" data-action="payment-methods#add" data-type="zelle"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z"/>
          </svg>
          Zelle
        </button>
        <button type="button" data-action="payment-methods#add" data-type="cashapp"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm3.248 7.002l-.623.755a.488.488 0 01-.632.107 3.72 3.72 0 00-1.86-.503c-.957 0-1.598.382-1.598.921 0 .571.586.762 1.546.948 1.757.34 3.284.918 3.284 2.773 0 1.572-1.18 2.655-3.073 2.916v1.248a.378.378 0 01-.378.378h-1.11a.378.378 0 01-.378-.378v-1.279c-1.077-.132-2.068-.54-2.792-1.11a.488.488 0 01-.064-.718l.701-.756a.488.488 0 01.65-.078 3.899 3.899 0 002.145.659c1.088 0 1.77-.407 1.77-.998 0-.565-.537-.793-1.612-.998-1.86-.354-3.218-.998-3.218-2.773 0-1.477 1.12-2.549 2.899-2.821V4.956c0-.209.169-.378.378-.378h1.11c.209 0 .378.169.378.378v1.2c.903.116 1.714.418 2.377.852a.488.488 0 01.1.716z"/>
          </svg>
          Cash App
        </button>
        <button type="button" data-action="payment-methods#add" data-type="crypto"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125"/>
          </svg>
          Crypto
        </button>
        <button type="button" data-action="payment-methods#add" data-type="other"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/>
          </svg>
          <%= t("invoices.payment_methods.types.other") %>
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden proposal_id if present -->
  <% if invoice.proposal_id.present? %>
    <%= f.hidden_field :proposal_id %>
  <% end %>

  <!-- Submit -->
  <div class="flex justify-end gap-3 pt-4">
    <%= link_to t("common.cancel"), invoices_path, class: "px-5 py-2.5 bg-white/10 text-white text-sm font-medium rounded-full hover:bg-white/20 transition-all duration-200" %>
    <%= f.submit class: "px-6 py-2.5 bg-white text-black text-sm font-semibold rounded-full hover:bg-white/90 transition-all duration-200 cursor-pointer" %>
  </div>
<% end %>

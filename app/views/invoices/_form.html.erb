<%= form_with model: invoice, class: "space-y-6", data: { controller: "invoice-items" } do |f| %>
  <% if invoice.errors.any? %>
    <div class="bg-red-400/10 border border-red-400/20 rounded-xl p-4">
      <div class="flex items-start gap-3">
        <%= icon(:error, variant: :duotone, size: :sm, css_class: "text-red-400 flex-shrink-0 mt-0.5") %>
        <ul class="text-sm text-red-400 space-y-1">
          <% invoice.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    </div>
  <% end %>

  <!-- Client & Due Date -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
      <div>
        <%= f.label :client_id, t("invoices.client"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <%= f.collection_select :client_id, current_user.clients.order(:name), :id, :name,
            { prompt: t("invoices.select_client"), include_blank: false },
            { class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-white/30 focus:ring-0 transition-colors" } %>
      </div>

      <div>
        <%= f.label :due_date, t("invoices.due_date"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <%= f.date_field :due_date, class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-white/30 focus:ring-0 transition-colors" %>
      </div>
    </div>
  </div>

  <!-- Line Items -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
    <h2 class="text-lg font-semibold text-white mb-5"><%= t("invoices.line_items") %></h2>

    <!-- Header -->
    <div class="hidden sm:grid grid-cols-12 gap-3 px-4 mb-3">
      <div class="col-span-6 text-xs font-medium text-white/40 uppercase tracking-wider"><%= t("invoices.description") %></div>
      <div class="col-span-2 text-xs font-medium text-white/40 uppercase tracking-wider text-right"><%= t("invoices.qty") %></div>
      <div class="col-span-2 text-xs font-medium text-white/40 uppercase tracking-wider text-right"><%= t("invoices.rate") %></div>
      <div class="col-span-2 text-xs font-medium text-white/40 uppercase tracking-wider text-right"><%= t("invoices.amount") %></div>
    </div>

    <div data-invoice-items-target="container" class="space-y-3">
      <%= f.fields_for :invoice_items do |item_form| %>
        <%= render "invoice_item_fields", f: item_form %>
      <% end %>
    </div>

    <template data-invoice-items-target="template">
      <%= f.fields_for :invoice_items, InvoiceItem.new, child_index: "NEW_RECORD" do |item_form| %>
        <%= render "invoice_item_fields", f: item_form %>
      <% end %>
    </template>

    <button type="button" data-action="invoice-items#add" class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-white/10 text-white text-sm font-medium rounded-full hover:bg-white/20 transition-all duration-200">
      <%= icon(:new, size: :sm) %>
      <%= t("invoices.add_line_item") %>
    </button>
  </div>

  <!-- Discount & Deposit -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
    <h2 class="text-lg font-semibold text-white mb-5"><%= t("invoices.discounts_deposits") %></h2>

    <div class="grid grid-cols-1 gap-5 sm:grid-cols-3">
      <div>
        <%= f.label :discount_type, t("invoices.discount_type"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <%= f.select :discount_type,
            Invoice.discount_types.keys.map { |dt| [t("invoices.discount_types.#{dt}"), dt] },
            {},
            { class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white focus:outline-none focus:border-white/30 focus:ring-0 transition-colors" } %>
      </div>

      <div>
        <%= f.label :discount_value, t("invoices.discount_value"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <%= f.number_field :discount_value, step: 0.01, min: 0, class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-0 transition-colors", placeholder: "0.00" %>
      </div>

      <div>
        <%= f.label :deposit_percent, t("invoices.deposit_percent"), class: "block text-sm font-medium text-white/70 mb-2" %>
        <div class="relative">
          <%= f.number_field :deposit_percent, step: 1, min: 0, max: 100, class: "w-full px-4 py-3 pr-10 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-0 transition-colors", placeholder: "0" %>
          <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
            <span class="text-white/40">%</span>
          </div>
        </div>
        <p class="mt-2 text-xs text-white/40"><%= t("invoices.deposit_hint") %></p>
      </div>
    </div>
  </div>

  <!-- Tax Notes & Notes -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6 space-y-5">
    <div>
      <%= f.label :tax_notes, t("invoices.tax_notes"), class: "block text-sm font-medium text-white/70 mb-2" %>
      <%= f.text_field :tax_notes, class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-0 transition-colors", placeholder: t("invoices.tax_notes_placeholder") %>
      <p class="mt-2 text-xs text-white/40"><%= t("invoices.tax_notes_hint") %></p>
    </div>

    <div>
      <%= f.label :notes, t("invoices.notes"), class: "block text-sm font-medium text-white/70 mb-2" %>
      <%= f.text_area :notes, rows: 3, class: "w-full px-4 py-3 bg-white/5 border border-white/10 rounded-xl text-white placeholder-white/30 focus:outline-none focus:border-white/30 focus:ring-0 transition-colors resize-none", placeholder: t("invoices.notes_placeholder") %>
    </div>
  </div>

  <!-- Payment Methods -->
  <div class="bg-white/5 border border-white/10 rounded-2xl p-6"
       data-controller="payment-methods"
       data-payment-methods-methods-value="<%= invoice.payment_methods.to_json %>">
    <template data-payment-methods-target="iconsTemplate">
      <span data-icon="bank_transfer"><%= icon(:bank_transfer, size: :md) %></span>
      <span data-icon="paypal"><%= icon(:paypal, size: :md) %></span>
      <span data-icon="venmo"><%= icon(:venmo, size: :md) %></span>
      <span data-icon="cashapp"><%= icon(:cashapp, size: :md) %></span>
      <span data-icon="zelle"><%= icon(:zelle, size: :md) %></span>
      <span data-icon="crypto"><%= icon(:crypto, size: :md) %></span>
      <span data-icon="other"><%= icon(:payment_other, size: :md) %></span>
      <span data-icon="remove"><%= icon(:close, size: :sm) %></span>
    </template>
    <div class="flex items-center justify-between mb-5">
      <div>
        <h2 class="text-lg font-semibold text-white"><%= t("invoices.payment_methods.title") %></h2>
        <p class="text-sm text-white/40 mt-1"><%= t("invoices.payment_methods.description") %></p>
      </div>
    </div>

    <!-- Empty State -->
    <div data-payment-methods-target="emptyState" class="<%= 'hidden' if invoice.payment_methods.any? %> text-center py-6">
      <div class="w-12 h-12 bg-white/10 rounded-full flex items-center justify-center mx-auto mb-3">
        <%= icon(:credit_card, variant: :duotone, size: :lg, css_class: "text-white/40") %>
      </div>
      <p class="text-sm text-white/50"><%= t("invoices.payment_methods.empty_state") %></p>
    </div>

    <!-- Payment Methods List -->
    <div data-payment-methods-target="methodList" class="space-y-4 mb-5"></div>

    <!-- Add Payment Method Buttons -->
    <div class="border-t border-white/10 pt-5">
      <p class="text-xs text-white/40 uppercase tracking-wider mb-3"><%= t("invoices.payment_methods.add_method") %></p>
      <div class="flex flex-wrap gap-2">
        <button type="button" data-action="payment-methods#add" data-type="bank_transfer"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <%= icon(:bank_transfer, size: :sm) %>
          <%= t("invoices.payment_methods.types.bank_transfer") %>
        </button>
        <button type="button" data-action="payment-methods#add" data-type="paypal"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <%= icon(:paypal, size: :sm) %>
          PayPal
        </button>
        <button type="button" data-action="payment-methods#add" data-type="venmo"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <%= icon(:venmo, size: :sm) %>
          Venmo
        </button>
        <button type="button" data-action="payment-methods#add" data-type="zelle"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <%= icon(:zelle, size: :sm) %>
          Zelle
        </button>
        <button type="button" data-action="payment-methods#add" data-type="cashapp"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <%= icon(:cashapp, size: :sm) %>
          Cash App
        </button>
        <button type="button" data-action="payment-methods#add" data-type="crypto"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <%= icon(:crypto, size: :sm) %>
          Crypto
        </button>
        <button type="button" data-action="payment-methods#add" data-type="other"
                class="inline-flex items-center gap-2 px-3 py-2 bg-white/5 border border-white/10 text-white/70 text-xs font-medium rounded-lg hover:bg-white/10 hover:text-white transition-all">
          <%= icon(:payment_other, size: :sm) %>
          <%= t("invoices.payment_methods.types.other") %>
        </button>
      </div>
    </div>
  </div>

  <!-- Hidden proposal_id if present -->
  <% if invoice.proposal_id.present? %>
    <%= f.hidden_field :proposal_id %>
  <% end %>

  <!-- Submit -->
  <div class="flex justify-end gap-3 pt-4">
    <%= link_to t("common.cancel"), invoices_path, class: "px-5 py-2.5 bg-white/10 text-white text-sm font-medium rounded-full hover:bg-white/20 transition-all duration-200" %>
    <%= f.submit class: "px-6 py-2.5 bg-white text-black text-sm font-semibold rounded-full hover:bg-white/90 transition-all duration-200 cursor-pointer" %>
  </div>
<% end %>
